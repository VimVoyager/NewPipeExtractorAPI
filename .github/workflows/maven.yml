# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java and maven CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

defaults:
  run:
    working-directory: app/

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        cache-dependency-path: 'app/pom.xml'
    
    - name: Build project
      run: mvn clean compile -DskipTests -B

  unit-tests:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        cache-dependency-path: 'app/pom.xml'

    - name: Run unit tests
      run: mvn test

    - name: Upload unit test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: 'app/target/surefire-reports/*Test.xml'
        retention-days: 7

  integration-tests:
     name: Integration Tests
     needs: build
     runs-on: ubuntu-latest

     steps:
     - name: Checkout code
       uses: actions/checkout@v4

     - name: Set up JDK 21
       uses: actions/setup-java@v4
       with:
         java-version: '21'
         distribution: 'temurin'
         cache: 'maven'
         
     - name: Run integration tests
       run: mvn verify -DskipUnitTests=true
       env:
        SPRING_PROFILES_ACTIVE: test
        CI: true

     - name: Upload integration test results
       if: always()
       uses: actions/upload-artifact@v4
       with:
         name: integration-test-results
         path: 'app/target/failsafe-reports/*IntegrationTest.xml'
         retention-days: 7

  code-coverage:
    name: Code Coverage
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: 'app/pom.xml'

      - name: Run tests with coverage
        run: mvn clean verify
        env:
          CI: true
      
      - name: Generate coverage report
        run: mvn jacoco:report
        continue-on-error: true
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: 'app//target/site/jacoco/'
          retention-days: 30

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: 'app/pom.xml'
      
      # Optional: Add Checkstyle
      - name: Run Checkstyle
        run: mvn checkstyle:check
        continue-on-error: true
      
      # Optional: Add SpotBugs
      - name: Run SpotBugs
        run: mvn spotbugs:check
        continue-on-error: true

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'OpenTube-API'
          path: '.'
          format: 'HTML'
      
      - name: Upload dependency check results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 7
          
  test-report:
    name: Generate Test Report
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download unit test results
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: unit-test-results
        continue-on-error: true
      
      - name: Download integration test results
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: integration-test-results
        continue-on-error: true
      
      - name: Publish test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: |
            unit-test-results/**/*.xml
            integration-test-results/**/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            unit-test-results/**/*.xml
            integration-test-results/**/*.xml
          comment_mode: always
          check_name: Test Results Summary

  all-checks-passed:
    name: All Checks Passed
    needs: [unit-tests, integration-tests, code-coverage, code-quality, dependency-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Show Current Working Directory
        run: pwd

      - name: Check all jobs status
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.code-coverage.result }}" != "success" ]; then
            echo "One or more required checks failed"
            exit 1
          fi
          echo "All checks passed successfully!"



